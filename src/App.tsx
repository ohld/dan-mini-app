import { lazy, Suspense, useEffect } from 'react'
import { Routes, Route, useLocation } from 'react-router-dom'
import { Home } from './pages/Home'
import { trackPageView } from './analytics'

const postsImport = () => import('./pages/Posts').then(m => ({ default: m.Posts }))
const courseImport = () => import('./pages/AICourse').then(m => ({ default: m.AICourse }))
const closedImport = () => import('./pages/ClosedChannel').then(m => ({ default: m.ClosedChannel }))
const adsImport = () => import('./pages/Ads').then(m => ({ default: m.WorkTogether }))
const aboutImport = () => import('./pages/About').then(m => ({ default: m.About }))

const Posts = lazy(postsImport)
const AICourse = lazy(courseImport)
const ClosedChannel = lazy(closedImport)
const WorkTogether = lazy(adsImport)
const About = lazy(aboutImport)

// Preload all chunks after home page renders so subpages open instantly
function usePreloadChunks() {
  useEffect(() => {
    const preload = () => {
      postsImport()
      courseImport()
      closedImport()
      adsImport()
      aboutImport()
    }
    // requestIdleCallback not available in Telegram WebView (iOS)
    const id = typeof requestIdleCallback !== 'undefined'
      ? requestIdleCallback(preload)
      : setTimeout(preload, 100)
    return () => {
      typeof cancelIdleCallback !== 'undefined'
        ? cancelIdleCallback(id as number)
        : clearTimeout(id as number)
    }
  }, [])
}

function usePageTracking() {
  const location = useLocation()
  useEffect(() => {
    trackPageView(location.pathname)
  }, [location.pathname])
}

function App() {
  usePreloadChunks()
  usePageTracking()

  return (
    <Suspense fallback={null}>
      <Routes>
        <Route path="/" element={<Home />} />
        <Route path="/posts" element={<Posts />} />
        <Route path="/ai-course" element={<AICourse />} />
        <Route path="/closed" element={<ClosedChannel />} />
        <Route path="/work-together" element={<WorkTogether />} />
        <Route path="/about" element={<About />} />
      </Routes>
    </Suspense>
  )
}

export default App
